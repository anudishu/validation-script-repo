# Ansible Repository Structure - Detailed Explanation

This document provides a comprehensive explanation of the Ansible repository structure, the role of each directory and file, and how they work together for infrastructure automation and configuration management.

## ğŸ“ **Repository Overview**

This is a **production-ready Ansible project** designed for infrastructure automation with best practices for:
- **Multi-environment support** (RHEL 7, 8, 9)
- **Google Cloud IAP integration** for secure SSH connections
- **Modular role-based architecture**
- **Golden image creation** for consistent server deployments

---

## ğŸ—ï¸ **Directory Structure & Roles**

```
Ansible-new-updated/
â”œâ”€â”€ ğŸ“‹ ansible.cfg              # Ansible configuration file
â”œâ”€â”€ ğŸ“„ host.example.yml         # Example inventory template
â”œâ”€â”€ ğŸ“„ README.md               # Basic project documentation
â”œâ”€â”€ ğŸ“ playbooks/              # Main orchestration playbooks
â”œâ”€â”€ ğŸ“ roles/                  # Custom Ansible roles (reusable components)
â”œâ”€â”€ ğŸ“ roles-template/         # Template for creating new roles
â”œâ”€â”€ ğŸ“ scripts/                # Helper scripts and utilities
â”œâ”€â”€ ğŸ“ vars/                   # Environment-specific variables
â””â”€â”€ ğŸ“ docs/                   # Detailed documentation
```

---

## ğŸ“‹ **Core Configuration Files**

### **`ansible.cfg`** - Ansible Configuration
**Purpose**: Controls Ansible's behavior and settings for the entire project.

**Key Configurations:**
- `inventory = hosts.runtime.yml` - Uses dynamic inventory generated by scripts
- `host_key_checking = False` - Disables SSH host key verification (for CI/CD)
- `retry_files_enabled = False` - Prevents retry file clutter
- `forks = 10` - Runs 10 parallel operations for speed
- `timeout = 30` - SSH connection timeout
- `stdout_callback = yaml` - Better log readability
- `pipelining = True` - Faster SSH operations

**Why This Matters**: Optimized for **CI/CD pipelines** and **Google Cloud environments** with IAP.

### **`host.example.yml`** - Inventory Template
**Purpose**: Template showing how dynamic inventory should be structured.

**Key Features:**
- **IAP Integration**: Shows ProxyJump configuration for Google Cloud IAP
- **OS Login Support**: Dynamic user injection for service accounts
- **Security**: Disables strict host key checking (for automation)

**Real Usage**: This file is **dynamically generated** by the `render_hosts_iap.sh` script.

---

## ğŸ“ **Core Directories Explained**

### **`playbooks/` - Orchestration Layer**
**Purpose**: Contains the main Ansible playbooks that orchestrate server configurations.

**Contents:**
- `site.yml` - **Master playbook** that configures all server types
- `golden-image-rhel7.yml` - RHEL 7 golden image creation
- `golden-image-rhel8.yml` - RHEL 8 golden image creation  
- `golden-image-rhel9.yml` - RHEL 9 golden image creation

**Architecture Pattern:**
```yaml
# site.yml structure
- Web Servers Configuration
  - Pre-tasks (package updates)
  - Roles (common, nginx, ssl)
  - Post-tasks (verification)

- Application Servers Configuration
  - Pre-tasks (package updates)
  - Roles (common, application, monitoring)
  - Post-tasks (health checks)

- Database Servers Configuration
  - Pre-tasks (package updates)
  - Roles (common, mysql, backup)
  - Post-tasks (connectivity tests)
```

**Why This Structure**: Separates concerns while maintaining consistency across all server types.

### **`roles/` - Reusable Components**
**Purpose**: Contains custom Ansible roles for specific functionalities.

**Current Roles:**
- `install-database-client/` - Installs PostgreSQL client tools
- `install-nodejs/` - Installs and configures Node.js runtime  
- `install-java-sdk/` - Installs Java SDK (JDK) with version-specific support

**Standard Role Structure:**
```
role-name/
â”œâ”€â”€ tasks/main.yml      # Main tasks to execute
â”œâ”€â”€ handlers/           # Event-driven tasks (restart services)
â”œâ”€â”€ defaults/main.yml   # Default variables
â”œâ”€â”€ vars/main.yml       # Role-specific variables
â”œâ”€â”€ files/              # Static files to copy
â”œâ”€â”€ templates/          # Jinja2 templates
â””â”€â”€ meta/main.yml       # Role metadata and dependencies
```

**Benefits:**
- **Reusability**: Use across multiple playbooks
- **Modularity**: Each role has a single responsibility
- **Testing**: Roles can be tested independently

### **`roles-template/` - Role Creation Template**
**Purpose**: Provides a standardized template for creating new roles.

**Contents:**
- `tasks/main.yml` - Main task template
- `tasks/rhel7.yml` - RHEL 7 specific tasks
- `tasks/rhel8_9.yml` - RHEL 8/9 specific tasks
- `defaults/main.yml` - Default variables template
- `meta/main.yml` - Role metadata template

**Usage Pattern:**
```bash
# Create new role
cp -r roles-template/ roles/my-new-role/
# Customize the copied template
```

**Why Templates Matter**: Ensures **consistency** and **best practices** across all roles.

### **`vars/` - Environment Configuration**
**Purpose**: Stores environment-specific variables for different RHEL versions.

**Current Files:**
- `rhel7.yml` - Variables for RHEL 7 environments
- `rhel8.yml` - Variables for RHEL 8 environments  
- `rhel9.yml` - Variables for RHEL 9 environments

**Example Variables** (from `rhel8.yml`):
```yaml
db_runtime: "postgres"          # Database type
node_major: "18"               # Node.js major version
postgres_version: "14"         # PostgreSQL version
install_db_server: false       # Client vs server installation
```

**Benefits:**
- **Environment Isolation**: Different configs per OS version
- **Flexibility**: Override variables per environment
- **Maintainability**: Centralized configuration management

### **`scripts/` - Automation Utilities**
**Purpose**: Contains helper scripts for infrastructure automation.

**Key Script: `render_hosts_iap.sh`**
**Purpose**: Dynamically generates Ansible inventory with Google Cloud IAP configuration.

**How It Works:**
1. Takes instance name, project, zone, and optional user
2. Uses `gcloud compute ssh --dry-run` to get IAP ProxyJump settings
3. Generates `hosts.runtime.yml` with proper SSH configuration
4. Enables Ansible to connect through IAP tunnels

**Usage:**
```bash
./render_hosts_iap.sh vm-instance my-project us-central1-a user@domain.com
```

**Generated Output:**
```yaml
all:
  children:
    targets:
      hosts:
        vm-instance:
          ansible_host: vm-instance
          ansible_user: user@domain.com
          ansible_ssh_common_args: >-
            -o StrictHostKeyChecking=no
            -o UserKnownHostsFile=/dev/null
            -J <IAP-proxy-jump-config>
```

**Why This Matters**: Enables **secure, automated access** to GCP VMs without exposing SSH ports.

### **`docs/` - Documentation**
**Purpose**: Contains detailed documentation for specific integrations.

**Current Documentation:**
- `bitbucket-integration-guide.md` - Guide for integrating with Bitbucket pipelines

---

## ğŸ”„ **How Everything Works Together**

### **1. Golden Image Creation Workflow**
```
1. Choose RHEL version (7/8/9)
2. Run corresponding golden-image playbook
3. Playbook uses version-specific vars from vars/
4. Executes roles to install and configure software
5. Creates ready-to-use golden image
```

### **2. Dynamic Inventory Generation**
```
1. CI/CD pipeline calls render_hosts_iap.sh
2. Script queries gcloud for IAP configuration
3. Generates hosts.runtime.yml with proper SSH settings
4. Ansible uses this inventory to connect to VMs
```

### **3. Multi-Environment Deployment**
```
1. site.yml orchestrates all server types
2. Loads environment-specific variables from vars/
3. Applies appropriate roles based on server type
4. Runs verification tasks to ensure success
```

---

## ğŸ¯ **Key Benefits of This Structure**

### **ğŸ”’ Security**
- **IAP Integration**: Secure access without exposing SSH ports
- **OS Login**: Dynamic user management via Google Cloud
- **No Hardcoded Credentials**: Uses Google Cloud authentication

### **ğŸš€ Performance**
- **Parallel Execution**: 10 concurrent operations
- **SSH Pipelining**: Reduces connection overhead
- **Optimized Configuration**: Fast CI/CD execution

### **ğŸ”§ Maintainability**
- **Modular Roles**: Easy to update and test
- **Environment Separation**: Clear variable organization
- **Standardized Templates**: Consistent role creation

### **ğŸŒ Scalability**
- **Multi-Environment Support**: RHEL 7, 8, 9
- **Role Reusability**: Use across multiple projects
- **CI/CD Ready**: Designed for automation pipelines

---

## ğŸ“ **Usage Examples**

### **Create Golden Image**
```bash
# For RHEL 8
ansible-playbook -i hosts.runtime.yml playbooks/golden-image-rhel8.yml

# With custom variables
ansible-playbook -i hosts.runtime.yml playbooks/golden-image-rhel8.yml -e "node_major=20"
```

### **Configure All Servers**
```bash
# Generate inventory
./scripts/render_hosts_iap.sh my-vm my-project us-central1-a

# Run full site configuration
ansible-playbook -i hosts.runtime.yml playbooks/site.yml

# Run specific server type
ansible-playbook -i hosts.runtime.yml playbooks/site.yml --limit web_servers
```

### **Java SDK Role Example**
```bash
# Use Java role with specific version
ansible-playbook -i hosts.runtime.yml playbooks/golden-image-rhel8.yml --tags java

# Override Java version
ansible-playbook -i hosts.runtime.yml playbooks/golden-image-rhel8.yml --tags java -e "java_version=17"

# Check Java installation
ansible all -i hosts.runtime.yml -m shell -a "java -version && javac -version"
```

**Java Version Configuration by OS:**
- **RHEL 7**: Java 8 (java-1.8.0-openjdk-devel)
- **RHEL 8**: Java 11 (java-11-openjdk-devel) 
- **RHEL 9**: Java 17 (java-17-openjdk-devel)

**Features:**
- âœ… **Multi-version support**: Java 8, 11, 17, 21
- âœ… **Automatic JAVA_HOME**: Sets environment variable
- âœ… **Full SDK**: Installs both runtime (JRE) and development kit (JDK)
- âœ… **Version validation**: Verifies successful installation
- âœ… **Error handling**: Comprehensive diagnostics on failure

### **Create New Role**
```bash
# Copy template
cp -r roles-template/ roles/install-docker/

# Edit tasks/main.yml to add Docker installation tasks
# Edit defaults/main.yml for Docker-specific variables
```

---

## ğŸ† **Best Practices Implemented**

1. **ğŸ“ Directory Organization**: Clear separation of concerns
2. **ğŸ”„ Idempotency**: All tasks can run multiple times safely
3. **ğŸ§ª Testing**: Verification tasks ensure successful deployment
4. **ğŸ“Š Logging**: YAML output for better readability
5. **âš¡ Performance**: Optimized for speed and efficiency
6. **ğŸ” Security**: IAP integration and secure defaults
7. **ğŸ“š Documentation**: Comprehensive documentation and examples

---

**This Ansible repository represents enterprise-grade infrastructure automation with Google Cloud integration, perfect for creating consistent, secure, and scalable server deployments.**
