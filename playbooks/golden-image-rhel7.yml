- name: Build golden runtime image (RHEL 7)

  hosts: targets

  become: true

  gather_facts: true

  vars_files:

    - ../vars/rhel7.yml

 

  pre_tasks:

    - name: Assert RedHat family and RHEL 7

      assert:

        that:

          - ansible_os_family == "RedHat"

          - ansible_distribution_major_version | string == "7"

        fail_msg: "This playbook must run on RHEL 7 only"

     

    - name: Preflight | network reachability

      block:

        - command: curl -I https://rpm.nodesource.com/

          register: curl_nodesource

          changed_when: false

          retries: 5

          delay: 5

          unitl: curl_nodesource.rc == 0

      rescue:

        - fail:

            msg: "Preflight failed: Nodesource unreachable from {{ inventory_hostname }}"

 

  roles:

    - role: install-python

      tags: [python]

    - role: install-nodejs

      tags: [node]

    - role: install-database-client

      tags: [db]

 

  post_tasks:

    - name: Postflight | record versions (structured)

      shell: |

        set -e

        nodeV="$(node --version 2>/dev/null || echo unknown)"

        npmV="$(npm --version 2>/dev/null || echo unknown)"

        psqlV="$(psql --version 2>/dev/null || echo unknown)"

        printf '{"host":"%s","node":"%s","npm":"%s","db_runtime":"%s","psql":"%s"}\n' \

          "{{ inventory_hostname }}" "$nodeV" "$npmV" "{{ db_runtime }}" "$psqlV"

      register: summary_json

      changed_when: false

 

    - name: Save summary.json

      copy:

        dest: "artifacts/summary/{{ inventory_hostname }}.json"

        content: "{{ summary.json.stdout }}"

      delegate_to: localhost

      run_once: true

 

    - name: Collect guest logs

      fetch:

        src: "{{ item }}"

        dest: "artifacts/logs/{{ inventory_hostname }}/"

        flat: yes

      with_items:

        - /var/log/yum.log

        - /var/log/messages

      ignore_errors: true